###############################################################################
#   @author         :   Mahasri Kalavala
#   @date           :   04/15/2017
#   @package        :   Trash & Recycle
#   @description    :   Trash & Recycle Pickup Scheduler and Reminder
###############################################################################
homeassistant:
  customize:
    sensor.trash_day:
      friendly_name: Is it Trash Day today?
      icon: mdi:delete-variant
    sensor.recycle_day:
      friendly_name: Is it Recycle Day today?
      icon: mdi:recycle
    sensor.trash_pickup_day:
      friendly_name: Trach Pickup Day
      icon: mdi:calendar-today
      hidden: true
    sensor.number_of_days_to_trash_pickup:
      friendly_name: Number of Days to Trash Pickup
      icon: mdi:delete-variant
    sensor.recycle_pickup_day:
      friendly_name: Recycle Pickup Day
      icon: mdi:calendar-today
      hidden: true
    sensor.recycle_pickup_week:
      friendly_name: Recycle Pickup Week
      icon: mdi:calendar-today
      hidden: true
    sensor.current_week:
      friendly_name: Current Week is
      icon: mdi:calendar-question
    group.trash__recycle:
      friendly_name: Trash & Recycle
      icon: mdi:recycle

###############################################################################
#  UI Elements
###############################################################################
input_select:
  trash_pickup_day:
    name: Current Trash Pickup Day (Evey Week)
    options:
     - Monday
     - Tuesday
     - Wednesday
     - Thursday
     - Friday
     - Saturday
     - Sunday
    icon: mdi:delete-variant
  recycle_pickup_day:
    name: Current Recycle Pickup Day (Every Other Week)
    options:
     - Monday
     - Tuesday
     - Wednesday
     - Thursday
     - Friday
     - Saturday
     - Sunday
    icon: mdi:recycle
  recycle_pickup_week:
    name: Select Recycle Pickup Week based on Current Week above
    options:
     - Even Weeks
     - Odd Weeks
    icon: mdi:recycle
    
###############################################################################
#  Sensor Definitions
###############################################################################
sensor:
  - platform: mqtt
    state_topic: "/home/trashpickupday"
    name: "Trash Pickup Day"
    value_template: "{{ value }}"
    qos: 1  
  - platform: mqtt
    state_topic: "/home/recyclepickupday"
    name: "Recycle Pickup Day"
    value_template: "{{ value }}"
    qos: 1
  - platform: mqtt
    state_topic: "/home/recyclepickupweek"
    name: "Recycle Pickup Week"
    value_template: "{{ value }}"
    qos: 1

###############################################################################
# Sensor to hold info about current week is an odd week or an even week of the year
###############################################################################
  - platform: template
    sensors:
      current_week:
        value_template: >-
          {%- if (as_timestamp(now()) | timestamp_custom('%U', true) | int ) % 2 == 0 -%}
            Even Week (Week# {{ as_timestamp(now()) | timestamp_custom('%U', true) }})
          {%- else -%}
            Odd Week (Week# {{ as_timestamp(now()) | timestamp_custom('%U', true) }})
          {%- endif -%}

###############################################################################
# Trash  - Pickup schedule is EVERY week.
# Set the day to a day before the actual day leaving time for reminders
###############################################################################

  - platform: template
    sensors:
      trash_day:
        value_template: >-
          {%- set pickupDay = states.sensor.trash_pickup_day.state | lower -%}
          {%- macro day_of_week(timestamp) -%}
            {{ as_timestamp(timestamp)| timestamp_custom('%A', true) | lower }}
          {%- endmacro -%}
          {%- if day_of_week(now()) == pickupDay -%}
            yes
          {%- else -%}
            no
          {%- endif -%}

  - platform: template
    sensors:
      number_of_days_to_trash_pickup:
        value_template: >-
          {%- macro DayOfWeek(day) -%}
            {%- set day = day | lower -%}
            {%- if day == "sunday" -%}0
            {%- elif day == "monday" -%}1
            {%- elif day == "tuesday" -%}2
            {%- elif day == "wednesday" -%}3
            {%- elif day == "thursday" -%}4
            {%- elif day == "friday" -%}5
            {%- elif day == "saturday" -%}6
            {%- endif -%}
          {%- endmacro -%}
          {%- macro getDay(daysDiff) -%}
           {%- if daysDiff  < 0 -%}
             {{- daysDiff + 7 -}}
           {%- else -%}
             {{- daysDiff -}}
           {%- endif -%}
          {%- endmacro -%}
          {%- macro numberOfDaysToGo(pickupDay) -%}
            {% set daysDiff = (DayOfWeek(pickupDay) | int - as_timestamp(now())| timestamp_custom('%w', true) | int) %}
            {{ getDay(daysDiff) }}
          {%- endmacro -%}
          {%- set today = as_timestamp(now())| timestamp_custom('%A', true) -%}
          {%- set schedulePickupDay = states.input_select.recycle_pickup_day.state -%}
          {{- numberOfDaysToGo(states.input_select.trash_pickup_day.state) -}}

###############################################################################
# Recycle - Pickup schedule is every other week.
# Set the day to a day before the actual day leaving time for reminders
###############################################################################

  - platform: template
    sensors:
      recycle_day:
        value_template: >-
          {%- set pickupDay = states.sensor.recycle_pickup_day.state | lower -%}
          {% if states.input_select.recycle_pickup_week.state | lower == "even weeks" %}
            {%- set evenWeekPickup = true %}
          {% else %}
            {%- set evenWeekPickup = false %}
          {% endif %}
          {%- macro day_of_week(timestamp) -%}
            {{ as_timestamp(timestamp)| timestamp_custom('%A', true) | lower }}
          {%- endmacro %}      
          {%- macro week_number_of_year() -%}
            {{ as_timestamp(now()) | timestamp_custom('%U', true) | int }}
          {%- endmacro %}
          {%- macro is_it_this_week() -%}
            {%- if as_timestamp(now()) | timestamp_custom('%U', true) | int % 2 == 0 -%}
              {%- if evenWeekPickup == true -%}
                true
              {%- else -%}
                false
              {%- endif -%}
            {%- else -%}
              {%- if evenWeekPickup == true -%}
                false
              {%- else -%}
                true
              {%- endif -%}
            {%- endif -%}
          {%- endmacro -%}
          {%- macro is_it_today() -%}
          {%- if is_it_this_week() == "true" -%}
            {%- if day_of_week(now()) | lower == pickupDay -%}
              yes
            {%- else -%}
              no
            {%- endif -%}
          {%- else -%}
            no
          {%- endif -%}
          {%- endmacro -%}
          {{- is_it_today() -}}

  # - platform: template
    # sensors:
      # number_of_days_to_recycle_pickup:
        # value_template: >-
          # {%- macro DayOfWeek(day) -%}
            # {%- set day = day | lower -%}
            # {%- if day == "sunday" -%}0
            # {%- elif day == "monday" -%}1
            # {%- elif day == "tuesday" -%}2
            # {%- elif day == "wednesday" -%}3
            # {%- elif day == "thursday" -%}4
            # {%- elif day == "friday" -%}5
            # {%- elif day == "saturday" -%}6
            # {%- endif -%}
          # {%- endmacro -%}
          # {%- macro getDay(daysDiff) -%}
           # {%- if daysDiff  < 0 -%}
             # {{- daysDiff + 7 -}}
           # {%- else -%}
             # {{- daysDiff -}}
           # {%- endif -%}
          # {%- endmacro -%}
          # {%- macro numberOfDaysToGo(pickupDay) -%}
            # {% set daysDiff = (DayOfWeek(pickupDay) | int - as_timestamp(now())| timestamp_custom('%w', true) | int) %}
            # {{ getDay(daysDiff) }}
          # {%- endmacro -%}
          # {%- set today = as_timestamp(now())| timestamp_custom('%A', true) -%}
          # {%- set schedulePickupDay = states.input_select.recycle_pickup_day.state -%}
          # {{- numberOfDaysToGo(states.input_select.recycle_pickup_day.state) -}}
          
###############################################################################
#                               Automations
###############################################################################
automation:

###############################################################################
#  The schedule can be changed via UI. The updated schedules are saved in MQTT
#  The input_selects don't maintain state automatically - hence this code
#  These automations are hidden - no interaction with user is required.
#  Save & Restore Functionality
###############################################################################
  - alias: Trash Pickup Day Changed
    hide_entity: true
    trigger:
      platform: state
      entity_id: input_select.trash_pickup_day
    action:
      service: mqtt.publish
      data_template:
        topic: "/home/trashpickupday"
        retain: true
        payload: '{{ states.input_select.trash_pickup_day.state }}'
  
  - alias: Recycle Pickup Day Changed
    hide_entity: true
    trigger:
      platform: state
      entity_id: input_select.recycle_pickup_day
    action:
      service: mqtt.publish
      data_template:
        topic: "/home/recyclepickupday"
        retain: true
        payload: '{{ states.input_select.recycle_pickup_day.state }}'
  
  - alias: Recycle Pickup Week Changed
    hide_entity: true
    trigger:
      platform: state
      entity_id: input_select.recycle_pickup_week
    action:
      service: mqtt.publish
      data_template:
        topic: "/home/recyclepickupweek"
        retain: true
        payload: '{{ states.input_select.recycle_pickup_week.state }}'

  - alias: Restore Trash Recycle Settings on Startup
    hide_entity: true
    trigger:
      platform: homeassistant
      event: start
    action:
      - delay:
          minutes: 1      
      - service: input_select.select_option
        data_template:
          entity_id: input_select.trash_pickup_day
          option: "{{states.sensor.trash_pickup_day.state}}"
      - service: input_select.select_option
        data_template:
          entity_id: input_select.recycle_pickup_day
          option: "{{states.sensor.recycle_pickup_day.state}}"
      - service: input_select.select_option
        data_template:
          entity_id: input_select.recycle_pickup_week
          option: "{{states.sensor.recycle_pickup_week.state}}"

###############################################################################
#  Reminder code - Reminds 5 times every hour starting 4 PM
#  Conditions: Only notifies when someone is at home 
###############################################################################
  - alias: Trash and Recycle Pickup Reminder
    trigger:
      - platform: time
        after: '16:00:00'
      - platform: time
        after: '17:00:00'
      - platform: time
        after: '18:00:00'
      - platform: time
        after: '19:00:00'
      - platform: time
        after: '20:00:00'
      - platform: time
        after: '21:00:00'
    condition:
      condition: and
      conditions:
      - condition: state
        entity_id: group.all_devices
        state: 'home'
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.trash_day
            state: 'yes'
          - condition: state
            entity_id: sensor.recycle_day
            state: 'yes'
    action:
      - service: script.notify_me
        data_template:
          value1: >
            {% if states.sensor.trash_day.state == "yes" %}
              Tomorrow is the Trash Pickup day. Put the Trash bin outside, please!
            {% elif states.sensor.recycle_day.state == "yes" %}
              Tomorrow is the Recycle Pickup day. Put the Recycle bin outside, please!              
            {% endif %}
          value2: ""
      - service: script.voice_notify
        data_template:
          value1: >
            {% if states.sensor.trash_day.state == "yes" %}
              Attention!: Tomorrow is the Trash Pickup day. Please don't forget to put the Trash bin outside tonight!
            {% elif states.sensor.recycle_day.state == "yes" %}
              Attention!: Tomorrow is the Recycle Pickup day. Please don't forget to put the recycle bin outside tonight!
            {% endif %}
          value2: ""
